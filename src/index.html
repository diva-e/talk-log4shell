<!doctype html>
<html lang="de">
<head>
    <meta charset="utf-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">

    <title>diva-e - Die Technik hinter Log4Shell & Co.</title>

    <link rel="stylesheet" href="/node_modules/reveal.js/dist/reset.css">
    <link rel="stylesheet" href="/node_modules/reveal.js/dist/reveal.css">
    <link rel="stylesheet" href="theme/diva-e.css">

    <!-- Theme used for syntax highlighted code -->
    <link rel="stylesheet" href="/node_modules/highlight.js/styles/intellij-light.css">

</head>
<body>
<div class="reveal">
    <div class="slides">

        <section class="title">
            <div class="header"></div>
            <div class="content">
                <h1>Die Technik hinter Log4Shell & Co.</h1>
                <p><small>Christoph Wende und Christian Kumpe, 17. Mai 2022, Entwicklertag Karlsruhe</small></p>
            </div>
        </section>

        <section>
            <div class="header">Prästentationstitel - Kapitel</div>
            <div class="content">
                <h2>Agenda</h2>
                <ol>
                    <li>Ich bin ein Blindtext.</li>
                    <li>Ich bin ein Blindtext.</li>
                    <li>
                        Ich bin ein Blindtext.
                        <ul>
                            <li>Es hat lange gedauert, bis ich begriffen habe, was es bedeutet, ein blinder Text zu sein.</li>
                            <li>Man macht keinen Sinn. Man wirkt hier und da aus dem Zusammenhang gerissen. Oft wird man gar nicht erst gelesen.</li>
                            <li>Aber bin ich deshalb ein schlechter Text? Ich weiss, dass ich nie die Chance haben werde, im Stern zu erscheinen. Aber bin ich darum weniger
                                wichtig? Ich bin blind!
                            </li>
                        </ul>
                    </li>
                    <li>Ich bin ein Blindtext.</li>
                </ol>
            </div>
        </section>

        <section>
            <div class="header">Prästentationstitel - Kapitel</div>
            <div class="content">
            <pre><code data-line-numbers="3-5|8-10|13-15">@Target(ElementType.TYPE)
@Retention(RetentionPolicy.RUNTIME)
@SpringBootTest
@ActiveProfiles
public @interface SpringBootIntegrationTest {
    @AliasFor(annotation = ActiveProfiles.class, attribute = "profiles") String[] activeProfiles() default {"test"};
}
</code></pre>
            </div>
        </section>

        <!--
            Schritt 1: Nachladen von Bytecode (Christoph)
        -->

        <section class="magenta">
            <div class="header"></div>
            <div class="content">
                <h1>Nachladen von Bytecode</h1>
            </div>
        </section>

        <section>
          <div class="header">Log4Shell &mdash; Nachladen von Bytecode</div>
          <div class="content">
            <h2>Was?</h2>
            <ul>
              <li>Funktioniert nur mit JDK < 8u...</li>
            </ul>
            <h2>Wie?</h2>

            <pre><code data-line-numbers="|5-7">package com.divae.tectalks.log4shell.exploit.basic.intro;

public class Step1_HelloWorld {

  static {
    System.out.println("Static initializer of HelloWorld");
  }

  public static void main(String[] args) {
    System.out.println("Hello World!");
  }

}
            </code></pre>
            <ul>
              <li>...</li>
            </ul>
          </div>
        </section>

        <section>
          <div class="header">Log4Shell &mdash; Nachladen von Bytecode</div>
          <div class="content">
            <h2>Was?</h2>
            <ul>
              <li>Funktioniert nur mit JDK < 8u...</li>
            </ul>
            <h2>Wie?</h2>
            <ul>
              <li>...</li>
            </ul>

            <pre><code data-line-numbers="|8|10-11">package com.divae.tectalks.log4shell.exploit.basic.intro;

import java.lang.reflect.Method;

public class Step2_ClassForName {

  public static void main(String[] args) throws Exception {
    Class&lt;?> helloWorldClass = Class.forName("com.divae...Step1_HelloWorld");

    Method mainMethod = helloWorldClass.getMethod("main", String[].class);
    mainMethod.invoke(null, (Object) new String[0]);
  }

}
            </code></pre>




          </div>
        </section>

        <section>
          <div class="header">Log4Shell &mdash; Nachladen von Bytecode</div>
          <div class="content">
            <h2>Was?</h2>
            <ul>
              <li>Funktioniert nur mit JDK < 8u...</li>
            </ul>
            <h2>Wie?</h2>
            <ul>
              <li>...</li>
            </ul>
            <pre><code data-line-numbers="|10|10,12|12,14-15|12|12,18-22">package com.divae.tectalks.log4shell.exploit.basic.intro;

import java.io.File;
import java.lang.reflect.Method;
import java.nio.file.Files;

public class Step3_ClassForBytes {

  public static void main(String[] args) throws Exception {
    byte[] bytes = Files.readAllBytes(new File("target/classes/.../Step1_HelloWorld.class").toPath());

    Class&lt;?> helloWorldClass = new OverloadedClassLoader().defineClass(bytes);

    Method mainMethod = helloWorldClass.getMethod("main", String[].class);
    mainMethod.invoke(null, (Object) new String[0]);
  }

  private static class OverloadedClassLoader extends ClassLoader {
    Class&lt;?> defineClass(byte[] bytes) {
      return defineClass(null, bytes, 0, bytes.length, null);
    }
  }
}
            </code></pre>

          </div>
        </section>

        <!--
            Schritt 2: Verbesserter Angriff über Deserialization (Christian)
        -->

        <section class="magenta">
            <div class="header"></div>
            <div class="content">
                <h1>Advanced Attack with Deserialization</h1>
            </div>
        </section>

        <section>
            <div class="header">Log4Shell &mdash; Verbesserter Angriff über Deserialization</div>
            <div class="content">
                <h2>Warum?</h2>
                <ul>
                    <li>Funktioniert auch mit JDK > 8u...</li>
                    <li>Muss aber LDAP Server erreichen können.</li>
                </ul>
                <h2>Wie?</h2>
                <ul>
                    <li>Bytecode für Payload in Daten verpacken.</li>
                </ul>
            </div>
        </section>

        <section>
            <div class="header">Die Technik hinter Log4Shell & Co. &mdash; Grundlagen der Java Serialisierung</div>
            <div class="content">
                <p>Daten mit Java Serialisieren und Deserialisieren</p>
                <pre class="code"><code data-trim data-line-numbers="5-9|13-15|17-23|25-32" class="java">
import java.io.*;

public class SerializationBasics {

    public static class SerializableClass implements Serializable {

        private int value = 0;

    }

    public static void main(String[] args) throws Exception {

        // Objekt erzeugen und Wert zuweisen
        SerializableClass serializableObject = new SerializableClass();
        serializableObject.value = 1;

        // Objekt in Datei schreiben
        try (FileOutputStream file = new FileOutputStream("serialized-data.tmp");
             ObjectOutputStream out = new ObjectOutputStream(file)) {

            out.writeObject(serializableObject);

        }

        // Objekt aus Datei lesen und Wert anzeigen
        try (FileInputStream file = new FileInputStream("serialized-data.tmp");
             ObjectInputStream in = new ObjectInputStream(file)) {

            SerializableClass deserializedObject = (SerializableClass) in.readObject();
            System.out.println("Eingelesener Wert: " + deserializedObject.value);

        }

    }

}
                </code></pre>
                <div class="fragment">
                    <p class="play-icon">Ausgabe des Beispiels</p>
                    <pre class="output"><code data-trim class="console">
Eingelesener Wert: 1
                </code></pre>
                </div>
            </div>
        </section>

        <section>
            <div class="header">Die Technik hinter Log4Shell & Co. &mdash; Grundlagen der Java Serialisierung</div>
            <div class="content">
                <p>Code beim De-/Serialisieren ausführen</p>
                <pre class="code"><code data-trim data-line-numbers="5-17|21-33" class="java">
import java.io.*;

public class SerializationBasics {

    public static class SerializableClass implements Serializable {

        private int value = 0;

        private void writeObject(ObjectOutputStream out) {
            System.out.println("writeObject wird ausgeführt");
        }

        private void readObject(ObjectInputStream in) {
            System.out.println("readObject wird ausgeführt");
        }

    }

    public static void main(String[] args) throws Exception {

        SerializableClass serializableObject = new SerializableClass();
        serializableObject.value = 1;

        try (FileOutputStream file = new FileOutputStream("serialized-data.tmp");
             ObjectOutputStream out = new ObjectOutputStream(file)) {
            out.writeObject(serializableObject);
        }

        try (FileInputStream file = new FileInputStream("serialized-data.tmp");
             ObjectInputStream in = new ObjectInputStream(file)) {
            SerializableClass deserializedObject = (SerializableClass) in.readObject();
            System.out.println("Eingelesener Wert: " + deserializedObject.value);
        }

    }

}
                </code></pre>
                <div class="fragment">
                    <p class="play-icon">Ausgabe des Beispiels</p>
                    <pre class="output"><code data-trim class="console">
writeObject wird ausgeführt
readObject wird ausgeführt
Eingelesener Wert: 0
                </code></pre>
                </div>
            </div>
        </section>

        <section>
            <div class="header">Prästentationstitel - Kapitel</div>
            <div class="content">
                <pre><code data-trim data-line-numbers="5-7|10-12|14-18|20-25">
import java.io.*;

public class SerializationBasics {

    public static class SerializableClass implements Serializable {
        private int value = 0;
    }

    public static void main(String[] args) throws Exception {
        // Instantiate the object
        SerializableClass serializableObject = new SerializableClass();
        serializableObject.value = 1;

        // Serialize the object into a file
        try (FileOutputStream file = new FileOutputStream("serialized-data.tmp");
             ObjectOutputStream out = new ObjectOutputStream(file)) {
            out.writeObject(serializableObject);
        }

        // Deserialize the file to an object
        try (FileInputStream file = new FileInputStream("serialized-data.tmp");
             ObjectInputStream in = new ObjectInputStream(file)) {
            SerializableClass deserializedObject = (SerializableClass) in.readObject();
            System.out.println("Deserialized value (should be 1): " + deserializedObject.value);
        }
    }

}
                </code></pre>
            </div>
        </section>

        <!--
            Fazit
        -->

        <section class="blue">
            <div class="header"></div>
            <div class="content">
                <h1>Kapitel/Trennseite</h1>
            </div>
        </section>

        <section class="gold">
            <div class="header"></div>
            <div class="content">
                <h1>Kapitel/Trennseite</h1>
            </div>
        </section>

        <section class="gray">
            <div class="header"></div>
            <div class="content">
                <h1>Kapitel/Trennseite</h1>
            </div>
        </section>

        <section class="thanks">
            <div class="header">
                <h1>diva-e. You can’t buy it. You can’t make it.<br>
                    And you sure can’t fake it.</h1>
            </div>
            <div class="content">
                <h1>Danke</h1>
                <p>Bitte gebt uns Feedback!</p>
            </div>
            <div class="footnote">
                <p>Copyright © diva-e
                <p>Alle Angaben basieren auf dem derzeitigen Kenntnisstand. Änderungen vorbehalten. Dieses Dokument der diva-e Digital Value Excellence GmbH ist ausschließlich für
                    den Adressaten bzw. Auftraggeber bestimmt. Es bleibt bis zur einer ausdrücklichen Übertragung von Nutzungsrechten Eigentum der diva-e. Jede Bearbeitung,
                    Verwertung, Vervielfältigung und/oder gewerbsmäßige Verbreitung des Werkes ist nur mit Einverständnis von diva-e zulässig.
                <p>All content is based on the current state of communication. Subject to change. This document of diva-e Digital Value Exellence GmbH is only intended for the
                    client. It belongs to diva-e until its explicit transfer of usage rights. Any adaptation, utilization, copy and/or professional spreading has to be approved by
                    diva-e.
            </div>
        </section>

    </div>
</div>

<script type="module">

    import Reveal from '/node_modules/reveal.js/dist/reveal.esm.js';
    import Markdown from '/node_modules/reveal.js/plugin/markdown/markdown.esm.js';
    import Highlight from '/node_modules/reveal.js/plugin/highlight/highlight.esm.js';

    // More info about initialization & config:
    // - https://revealjs.com/initialization/
    // - https://revealjs.com/config/
    Reveal.initialize({
        width: 1500,
        height: 843,
        margin: 0.05,
        hash: true,
        slideNumber: true,

        // Learn about plugins: https://revealjs.com/plugins/
        plugins: [Markdown, Highlight]
    });
</script>
</body>
</html>
